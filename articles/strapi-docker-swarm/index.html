<!doctype html><html lang=en><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><style>:root{--accent-color:#FF4D4D}</style><title>Strapi - запуск в Docker Swarm</title>
<meta name=description content="Lead developer"><meta name=keywords content='ладыгин сергей,Strapi,Docker Swarm'><meta property="og:url" content="https://updev.ru/articles/strapi-docker-swarm/"><meta property="og:type" content="website"><meta property="og:title" content="Strapi - запуск в Docker Swarm"><meta property="og:description" content="Lead developer"><meta property="og:image" content="/articles/strapi-docker-swarm/cover.png"><meta name=twitter:card content="summary_large_image"><meta name=twitter:title content="Strapi - запуск в Docker Swarm"><meta name=twitter:description content="Lead developer"><meta property="twitter:domain" content="https://updev.ru/articles/strapi-docker-swarm/"><meta property="twitter:url" content="https://updev.ru/articles/strapi-docker-swarm/"><meta name=twitter:image content="/articles/strapi-docker-swarm/cover.png"><link rel=canonical href=https://updev.ru/articles/strapi-docker-swarm/><link rel=stylesheet type=text/css href=https://updev.ru//css/normalize.min.css media=print onload='this.media="all"'><link rel=stylesheet type=text/css href=https://updev.ru//css/main.css><link disabled id=dark-theme rel=stylesheet href=https://updev.ru//css/dark.css><script src=https://updev.ru//js/svg-injector.min.js></script><script src=https://updev.ru//js/feather-icons.min.js></script><script src=https://updev.ru//js/main.js></script><link rel=stylesheet type=text/css href=/css/base.css><script type=text/javascript>(function(e,t,n,s,o,i,a){e[o]=e[o]||function(){(e[o].a=e[o].a||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)})(window,document,"script","https://mc.yandex.ru/metrika/tag.js","ym"),ym(89940266,"init",{clickmap:!0,trackLinks:!0,accurateTrackBounce:!0})</script><noscript><div><img src=https://mc.yandex.ru/watch/89940266 style=position:absolute;left:-9999px alt></div></noscript></head><body><script type=text/javascript>setThemeByUserPref()</script><header class=header><nav class=header-nav><div class=avatar><a href=https://updev.ru/><img src=https://updev.ru//images/avatar.jpg alt=avatar></a></div><div class=nav-title><a class=nav-brand href=https://updev.ru/>Ладыгин Сергей</a></div><div class=nav-links><div class=nav-link><a href=https://updev.ru/projects/>Проекты</a></div><div class=nav-link><a href=https://updev.ru/articles/>Статьи</a></div><div class=nav-link><a href=https://updev.ru/radar/>Тех. радар</a></div><div class=nav-link><a href=https://github.com/updevru><span data-feather=github></span></a></div><div class=nav-link><a href=https://t.me/updevru><span data-feather=send></span></a></div><div class=nav-link><a href=https://updev.ru/index.xml><span data-feather=rss></span></a></div><span class=nav-icons-divider></span><div class="nav-link dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></div><div class=nav-link id=hamburger-menu-toggle><a><span data-feather=menu></span></a></div><ul class="nav-hamburger-list visibility-hidden"><li class=nav-item><a href=https://updev.ru/projects/>Проекты</a></li><li class=nav-item><a href=https://updev.ru/articles/>Статьи</a></li><li class=nav-item><a href=https://updev.ru/radar/>Тех. радар</a></li><li class=nav-item><a href=https://github.com/updevru><span data-feather=github></span></a></li><li class=nav-item><a href=https://t.me/updevru><span data-feather=send></span></a></li><li class=nav-item><a href=https://updev.ru/index.xml><span data-feather=rss></span></a></li><li class="nav-item dark-theme-toggle"><a><span id=theme-toggle-icon data-feather=moon></span></a></li></ul></div></nav></header><main id=content class=page-type-post><div class="post container"><div class=post-header-section><h1>Strapi - запуск в Docker Swarm</h1><small role=doc-subtitle></small><p class=post-date>мая 4, 2024</p><ul class=post-tags><li class=post-tag><a href=https://updev.ru/tags/strapi>Strapi</a></li><li class=post-tag><a href=https://updev.ru/tags/docker-swarm>Docker Swarm</a></li></ul></div><div class=post-content><p><p><img src=cover.png alt></p><p>После того как мы создали первую версию нашего приложения, создали Dockerfile, проверили работоспособность приложения в контейнере,
встает вопрос как это выложить на prod, и самое главное как его обновлять далее.</p><p>Можно пойти в Kubernetes, но если у вас не большое количество сервисов и нет отдельного отдела для обслуживания Kubernetes,
то следуют выбрать что-то попроще.</p><p>Экосистема Docker предлагает нам воспользоваться режимом <a href=https://docs.docker.com/engine/swarm/>swarm mode</a>.
В этом режиме, можно объединять несколько серверов в один кластер и запускать в нем приложения точно так же, как на одном сервере.</p><p>Удобные особенности swarm mode, которые облегчают поддержку и обновление сервисов запускаемых через docker:</p><ul><li>deploy без downtime из коробки (правильные порядок запуска и старт новой версии с последующей остановкой старой)</li><li>объединение нескольких серверов в кластер</li><li>overlay сеть поверх всех хостов</li><li>автоматическое распределение сервисов по серверам</li></ul><p><a href=https://mermaid.live/edit#pako:eNpVj7EKwkAMhl_lyFwntyKCWJwUlKuLPYfQS-th2yu5FJHSd_e0Opgp_N8HyT9C6S1BClXjH-UNWVSemU7F2RQ5I1XuflWrxWKtdKGFsXfXGes5zYqjD1IzBX3a_6NdoZcqiGes6Uu24zkQTzPfQAItcYvOxgfGt2FAbtSSgTSuliocGjFguimqOIjXz66EVHigBIbeolDmsGZsfyFZFw8e5k6fagn02F28j0qFTaDpBdzpTZ0><img src="https://mermaid.ink/img/pako:eNpVj7EKwkAMhl_lyFwntyKCWJwUlKuLPYfQS-th2yu5FJHSd_e0Opgp_N8HyT9C6S1BClXjH-UNWVSemU7F2RQ5I1XuflWrxWKtdKGFsXfXGes5zYqjD1IzBX3a_6NdoZcqiGes6Uu24zkQTzPfQAItcYvOxgfGt2FAbtSSgTSuliocGjFguimqOIjXz66EVHigBIbeolDmsGZsfyFZFw8e5k6fagn02F28j0qFTaDpBdzpTZ0?type=png" alt></a></p><h2 id=установка-docker>Установка Docker</h2><p>Для начала необходимо установить <a href=https://docs.docker.com/engine/install/>Docker</a>
и <a href=https://docs.docker.com/compose/install/linux/>Docker compose</a> на сервер.</p><h2 id=переключение-в-swarm-mode>Переключение в swarm mode</h2><pre tabindex=0><code>docker swarm init
</code></pre><p>В консоли отобразиться команда для добавления в кластер других серверов.</p><p>Рекомендую на будущее создать overlay сети, чтобы в позже можно было легко подключать дополнительные сервера.</p><pre tabindex=0><code>docker network create --driver overlay --attachable cluster-network
</code></pre><h2 id=proxy-сервис>Proxy сервис</h2><p>Если нам на одном сервере необходимо использовать больше одного приложения, которые слушают 80 или 443 порты,
то необходимо использовать прокси nginx, Traefik, Envoy или другой. Такой прокси сервис принимает http запросы и на основании url распределяют запросы по сервисам.</p><p>В качестве gateway рекомендую использовать <a href=https://traefik.io>Traefik</a>.</p><p>Он удобен:</p><ul><li>автоматически считывает конфигурацию из labels контейнеров</li><li>умеет проксировать трафик до наших сервисов и распределять нагрузку</li><li>самостоятельно создает и обновляет сертификат через letsencrypt.org</li></ul><p>Для этой роли можем использовать и nginx, но количество ручной работы будет сильно больше.</p><p>Для публикации сервиса достаточно прописать labels, например так:</p><pre tabindex=0><code>services:
  strapi:
    deploy:
      labels:
        - traefik.http.routers.strapi.rule=Host(`strapi.project.ru`)
        - traefik.http.services.strapi.loadbalancer.server.port=1337
        - traefik.http.routers.strapi.entrypoints=websecure
        - traefik.http.routers.strapi.tls.certresolver=default
</code></pre><p>Этот сервис будет принимать весь трафик с доменом strapi.project.ru по https, так же автоматически будет создан сертификат.</p><h2 id=подготовка-docker-composeyaml>Подготовка docker-compose.yaml</h2><p>Что и как запускать описывается в уже знакомом формате docker-compose.yaml.</p><pre tabindex=0><code>services:
  proxy:
    image: traefik:v2.9
    ports:
      - &#34;80:80&#34;
      - &#34;443:443&#34;
    networks:
      - global
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - proxy-acme:/acme
    command:
      - &#34;--api.insecure=true&#34;
      - &#34;--providers.docker=true&#34;
      - &#34;--providers.docker.swarmMode=true&#34;
      - &#34;--providers.docker.exposedbydefault=false&#34;
      - &#34;--entrypoints.web.address=:80&#34;
      - &#34;--entrypoints.websecure.address=:443&#34;
      - &#34;--certificatesresolvers.default.acme.httpchallenge=true&#34;
      - &#34;--certificatesresolvers.default.acme.httpchallenge.entrypoint=web&#34;
      - &#34;--certificatesresolvers.default.acme.email=notify@email.ru&#34;
      - &#34;--certificatesresolvers.default.acme.storage=/acme/acme.json&#34;
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 2
        delay: 15s
        order: start-first

  postgres:
    image: postgres:16.2
    volumes:
      - postgres-data:/var/lib/postgresql/data
    networks:
      - global
    environment:
      TZ: &#34;Europe/Moscow&#34;
      POSTGRES_DB: strapi
      POSTGRES_USER: strapi
      POSTGRES_PASSWORD: strapi
    deploy:
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 1
        order: stop-first

  strapi:
    image: updev/strapi
    networks:
      - global
    environment:
      APP_URL: &#34;https://strapi.project.ru&#34;
      APP_KEYS: 33h8bQmgX7sRpIFzEAYSiA==,jn0G/M0akKqWgq73iC+n4w==,o7ZmUZONopLPZiwuoRJ9XA==,hU+7Ra9xwrN+7ZtWXeO+7g==
      API_TOKEN_SALT: K/QGU......3Gw==
      ADMIN_JWT_SECRET: 1PI.....Gvw==
      TRANSFER_TOKEN_SALT: ni......hA==
      DATABASE_CLIENT: postgres
      DATABASE_HOST: postgres
      DATABASE_PORT: 5432
      DATABASE_NAME: strapi
      DATABASE_USERNAME: strapi
      DATABASE_PASSWORD: strapi
      YC_BUCKET: strapi-data
      YC_ACCESS_KEY_ID: YC....Yk
      YC_ACCESS_SECRET: YCO....LyaE
      JWT_SECRET: 0wd.....tGKg==
    depends_on:
      - postgres
    deploy:
      labels:
        - traefik.enable=true
        - traefik.docker.network=cluster-network
        - traefik.http.routers.strapi.rule=Host(`strapi.project.ru`)
        - traefik.http.services.strapi.loadbalancer.server.port=1337
        - traefik.http.routers.strapi.entrypoints=websecure
        - traefik.http.routers.strapi.tls.certresolver=default
      mode: replicated
      replicas: 1
      update_config:
        parallelism: 2
        delay: 60s
        order: start-first
        failure_action: rollback
      restart_policy:
        condition: on-failure
        delay: 15s

volumes:
  postgres-data:
  proxy-acme:

networks:
  global:
    external: true
    name: cluster-network
</code></pre><p>В нем описаны:</p><ul><li>Прокси сервис - Traefik</li><li>База данных PostgresSQL</li><li>Strapi</li></ul><p>Вместо <code>notify@email.ru</code>, <code>strapi.project.ru</code> укажите свои данные.
У сервиса strapi укажите свои секреты и ключи в секции environment.</p><h2 id=запуск-сервиса>Запуск сервиса</h2><p>Для запуска всех сервисов достаточно выполнить команду:</p><pre tabindex=0><code>docker stack deploy --compose-file ./docker-swarm/docker-compose.yaml strapi
</code></pre><p>Эта команда запустит все сервисы, описанные в файле.</p><h2 id=обновление-сервиса>Обновление сервиса</h2><p>Для обновления какого либо сервиса достаточно выполнить такую же команду, как и при запуске.</p><p>Сервисы обновятся только те, у которых:</p><ul><li>изменилась конфигурация в docker-compose.yaml</li><li>есть более новая версия образа</li></ul><p>За логику обновления отвечает секция <code>update_config</code> в docker-compose.yaml, документация по этой секции <a href=https://docs.docker.com/compose/compose-file/deploy/>тут</a>.</p><p>Разберем на примере:</p><pre tabindex=0><code>deploy:
  mode: replicated
  replicas: 1
  update_config:
    parallelism: 2
    delay: 15s
    order: start-first
    failure_action: rollback
  restart_policy:
    condition: on-failure
    delay: 15s
    max_attempts: 3
</code></pre><p><code>mode</code> - способ запуска в кластере (global - по одному на каждом сервере, replicated - указанное количество контейнеров).</p><p><code>replicas</code> - сколько копий сервиса запускать. Трафик будет распределяться между ними.</p><p><code>update_config</code> - описывает как обновлять сервис. В данном случае сначала будет запущена новая версия сервиса,
после того как он будет готов к работе он заменяет старый и через 15 секунд если с новым сервисом все хорошо - старый останавливается.
Если новая версия контейнера не запускается или падает, то возвращается в строй предыдущая версия.
Таким образом достигается обновление сервиса без простоя.</p><p><code>restart_policy</code> - описывает что делать, если контейнер останавливается.
В данном примере контейнер будет перезапущен до 3 раз, с промежутками в 15 секунд.</p><p>Исходный код руководства на <a href=https://github.com/updevru/tutorial-strapi-deploy>GitHub</a>.</p></p></div></div><aside class=post-toc><nav id=toc><nav id=TableOfContents><ul><li><ul><li><a href=#установка-docker>Установка Docker</a></li><li><a href=#переключение-в-swarm-mode>Переключение в swarm mode</a></li><li><a href=#proxy-сервис>Proxy сервис</a></li><li><a href=#подготовка-docker-composeyaml>Подготовка docker-compose.yaml</a></li><li><a href=#запуск-сервиса>Запуск сервиса</a></li><li><a href=#обновление-сервиса>Обновление сервиса</a></li></ul></li></ul></nav></nav></aside></main><footer class=footer><span>&copy; 2025 Ладыгин Сергей</span>
<span>Made with &#10084;&#65039; using <a target=_blank href=https://github.com/526avijitgupta/gokarna>Gokarna</a></span></footer></body></html>